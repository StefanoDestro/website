!function(root,factory){"function"==typeof define&&define.amd?define(factory):root.BackgroundCheck=factory(root)}(this,(function(){"use strict";var resizeEvent=void 0!==window.orientation?"orientationchange":"resize",supported,canvas,context,throttleDelay,viewport,attrs={};function init(a){if(void 0===a||void 0===a.targets)throw"Missing attributes";attrs.debug=checkAttr(a.debug,!1),attrs.debugOverlay=checkAttr(a.debugOverlay,!1),attrs.targets=getElements(a.targets),attrs.images=getElements(a.images||"img",!0),attrs.changeParent=checkAttr(a.changeParent,!1),attrs.threshold=checkAttr(a.threshold,50),attrs.minComplexity=checkAttr(a.minComplexity,30),attrs.minOverlap=checkAttr(a.minOverlap,50),attrs.windowEvents=checkAttr(a.windowEvents,!0),attrs.maxDuration=checkAttr(a.maxDuration,500),attrs.mask=checkAttr(a.mask,{r:0,g:255,b:0}),attrs.classes=checkAttr(a.classes,{dark:"background--dark",light:"background--light",complex:"background--complex"}),void 0===supported&&(checkSupport(),supported&&(canvas.style.position="fixed",canvas.style.top="0px",canvas.style.left="0px",canvas.style.width="100%",canvas.style.height="100%",window.addEventListener(resizeEvent,throttle.bind(null,(function(){resizeCanvas(),check()}))),window.addEventListener("scroll",throttle.bind(null,check)),resizeCanvas(),check()))}function destroy(){supported=null,canvas=null,context=null,attrs={},throttleDelay&&clearTimeout(throttleDelay)}function log(msg){get("debug")&&console.log(msg)}function checkAttr(value,def){return checkType(value,typeof def),void 0===value?def:value}function checkType(value,type){if(void 0!==value&&typeof value!==type)throw"Incorrect attribute type"}function checkForCSSImages(els){for(var el,url,list=[],e=0;e<els.length;e++)if(el=els[e],list.push(el),"IMG"!==el.tagName){if((url=window.getComputedStyle(el).backgroundImage).split(/,url|, url/).length>1)throw"Multiple backgrounds are not supported";if(!url||"none"===url)throw"Element is not an <img> but does not have a background-image";list[e]={img:new Image,el:list[e]},url=(url=url.slice(4,-1)).replace(/"/g,""),list[e].img.src=url,log("CSS Image - "+url)}return list}function getElements(selector,convertToImages){var els=selector;if("string"==typeof selector?els=document.querySelectorAll(selector):selector&&1===selector.nodeType&&(els=[selector]),!els||0===els.length||void 0===els.length)throw"Elements not found";return convertToImages&&(els=checkForCSSImages(els)),els=Array.prototype.slice.call(els)}function checkSupport(){(canvas=document.createElement("canvas"))&&canvas.getContext?(context=canvas.getContext("2d"),supported=!0):supported=!1,showDebugOverlay()}function showDebugOverlay(){get("debugOverlay")?(canvas.style.opacity=.5,canvas.style.pointerEvents="none",document.body.appendChild(canvas)):canvas.parentNode&&canvas.parentNode.removeChild(canvas)}function kill(start){var duration=(new Date).getTime()-start;log("Duration: "+duration+"ms"),duration>get("maxDuration")&&(console.log("BackgroundCheck - Killed"),removeClasses(),destroy())}function resizeCanvas(){viewport={left:0,top:0,right:document.body.clientWidth,bottom:window.innerHeight},canvas.width=document.body.clientWidth,canvas.height=window.innerHeight}function getValue(css,parent,delta){var value,percentage;return-1!==css.indexOf("px")?value=parseFloat(css):-1!==css.indexOf("%")?(value=(percentage=(value=parseFloat(css))/100)*parent,delta&&(value-=delta*percentage)):value=parent,value}function calculateAreaFromCSS(obj){var css=window.getComputedStyle(obj.el);obj.el.style.backgroundRepeat="no-repeat",obj.el.style.backgroundOrigin="padding-box";var size=css.backgroundSize.split(" "),width=size[0],height=void 0===size[1]?"auto":size[1],parentRatio=obj.el.clientWidth/obj.el.clientHeight,imgRatio=obj.img.naturalWidth/obj.img.naturalHeight;"cover"===width?parentRatio>=imgRatio?(width="100%",height="auto"):(width="auto",size[0]="auto",height="100%"):"contain"===width&&(1/parentRatio<1/imgRatio?(width="auto",size[0]="auto",height="100%"):(width="100%",height="auto")),width="auto"===width?obj.img.naturalWidth:getValue(width,obj.el.clientWidth),height="auto"===height?width/obj.img.naturalWidth*obj.img.naturalHeight:getValue(height,obj.el.clientHeight),"auto"===size[0]&&"auto"!==size[1]&&(width=height/obj.img.naturalHeight*obj.img.naturalWidth);var position=css.backgroundPosition,x,y;return"top"===position?position="50% 0%":"left"===position?position="0% 50%":"right"===position?position="100% 50%":"bottom"===position?position="50% 100%":"center"===position&&(position="50% 50%"),4===(position=position.split(" ")).length?(x=position[1],y=position[3]):(x=position[0],y=position[1]),y=y||"50%",x=getValue(x,obj.el.clientWidth,width),y=getValue(y,obj.el.clientHeight,height),4===position.length&&("right"===position[0]&&(x=obj.el.clientWidth-obj.img.naturalWidth-x),"bottom"===position[2]&&(y=obj.el.clientHeight-obj.img.naturalHeight-y)),x+=obj.el.getBoundingClientRect().left,y+=obj.el.getBoundingClientRect().top,{left:Math.floor(x),right:Math.floor(x+width),top:Math.floor(y),bottom:Math.floor(y+height),width:Math.floor(width),height:Math.floor(height)}}function getArea(obj){var area,image,parent;if(obj.nodeType){var rect=obj.getBoundingClientRect();area={left:rect.left,right:rect.right,top:rect.top,bottom:rect.bottom,width:rect.width,height:rect.height},parent=obj.parentNode,image=obj}else area=calculateAreaFromCSS(obj),parent=obj.el,image=obj.img;parent=parent.getBoundingClientRect(),area.imageTop=0,area.imageLeft=0,area.imageWidth=image.naturalWidth,area.imageHeight=image.naturalHeight;var ratio=area.imageHeight/area.height,delta;return area.top<parent.top&&(delta=parent.top-area.top,area.imageTop=ratio*delta,area.imageHeight-=ratio*delta,area.top+=delta,area.height-=delta),area.left<parent.left&&(delta=parent.left-area.left,area.imageLeft+=ratio*delta,area.imageWidth-=ratio*delta,area.width-=delta,area.left+=delta),area.bottom>parent.bottom&&(delta=area.bottom-parent.bottom,area.imageHeight-=ratio*delta,area.height-=delta),area.right>parent.right&&(delta=area.right-parent.right,area.imageWidth-=ratio*delta,area.width-=delta),area.imageTop=Math.floor(area.imageTop),area.imageLeft=Math.floor(area.imageLeft),area.imageHeight=Math.floor(area.imageHeight),area.imageWidth=Math.floor(area.imageWidth),area}function drawImage(image){var area=getArea(image);image=image.nodeType?image:image.img,area.imageWidth>0&&area.imageHeight>0&&area.width>0&&area.height>0?context.drawImage(image,area.imageLeft,area.imageTop,area.imageWidth,area.imageHeight,area.left,area.top,area.width,area.height):log("Skipping image - "+image.src+" - area too small")}function classList(node,name,mode){var className=node.className;switch(mode){case"add":className+=" "+name;break;case"remove":var pattern=new RegExp("(?:^|\\s)"+name+"(?!\\S)","g");className=className.replace(pattern,"")}node.className=className.trim()}function removeClasses(el){for(var targets=el?[el]:get("targets"),target,t=0;t<targets.length;t++)target=targets[t],classList(target=get("changeParent")?target.parentNode:target,get("classes").light,"remove"),classList(target,get("classes").dark,"remove"),classList(target,get("classes").complex,"remove")}function calculatePixelBrightness(target){var dims=target.getBoundingClientRect(),brightness,data,pixels=0,delta,deltaSqr=0,mean=0,variance,minOverlap=0,mask=get("mask");if(dims.width>0&&dims.height>0){removeClasses(target),target=get("changeParent")?target.parentNode:target,data=context.getImageData(dims.left,dims.top,dims.width,dims.height).data;for(var p=0;p<data.length;p+=4)data[p]===mask.r&&data[p+1]===mask.g&&data[p+2]===mask.b?minOverlap++:(pixels++,deltaSqr+=(delta=(brightness=.2126*data[p]+.7152*data[p+1]+.0722*data[p+2])-mean)*delta,mean+=delta/pixels);minOverlap<=data.length/4*(1-get("minOverlap")/100)&&(variance=Math.sqrt(deltaSqr/pixels)/255,mean/=255,log("Target: "+target.className+" lum: "+mean+" var: "+variance),classList(target,mean<=get("threshold")/100?get("classes").dark:get("classes").light,"add"),variance>get("minComplexity")/100&&classList(target,get("classes").complex,"add"))}}function isInside(a,b){return a=(a.nodeType?a:a.el).getBoundingClientRect(),b=b===viewport?b:(b.nodeType?b:b.el).getBoundingClientRect(),!(a.right<b.left||a.left>b.right||a.top>b.bottom||a.bottom<b.top)}function processTargets(checkTarget){for(var start=(new Date).getTime(),mode=checkTarget&&("IMG"===checkTarget.tagName||checkTarget.img)?"image":"targets",found=!checkTarget,total=get("targets").length,target,t=0;t<total;t++)isInside(target=get("targets")[t],viewport)&&("targets"!==mode||checkTarget&&checkTarget!==target?"image"===mode&&isInside(target,checkTarget)&&calculatePixelBrightness(target):(found=!0,calculatePixelBrightness(target)));if("targets"===mode&&!found)throw checkTarget+" is not a target";kill(start)}function getZIndex(el){var calculate=function(el){var zindex=0;return"static"!==window.getComputedStyle(el).position&&(zindex=parseInt(window.getComputedStyle(el).zIndex,10)||0)>=0&&zindex++,zindex},parent=el.parentNode,zIndexParent,zIndexEl;return 1e5*(parent?calculate(parent):0)+calculate(el)}function sortImagesByZIndex(images){var sorted=!1;return images.sort((function(a,b){a=a.nodeType?a:a.el,b=b.nodeType?b:b.el;var pos=a.compareDocumentPosition(b),reverse=0;return(a=getZIndex(a))>(b=getZIndex(b))&&(sorted=!0),a===b&&2===pos?reverse=1:a===b&&4===pos&&(reverse=-1),reverse||a-b})),log("Sorted: "+sorted),sorted&&log(images),sorted}function check(target,avoidClear,imageLoaded){if(supported){var mask=get("mask");log("--- BackgroundCheck ---"),log("onLoad event: "+(imageLoaded&&imageLoaded.src)),!0!==avoidClear&&(context.clearRect(0,0,canvas.width,canvas.height),context.fillStyle="rgb("+mask.r+", "+mask.g+", "+mask.b+")",context.fillRect(0,0,canvas.width,canvas.height));for(var processImages=imageLoaded?[imageLoaded]:get("images"),sorted=sortImagesByZIndex(processImages),image,imageNode,loading=!1,i=0;i<processImages.length;i++)isInside(image=processImages[i],viewport)&&(0===(imageNode=image.nodeType?image:image.img).naturalWidth?(loading=!0,log("Loading... "+image.src),imageNode.removeEventListener("load",check),sorted?imageNode.addEventListener("load",check.bind(null,null,!1,null)):imageNode.addEventListener("load",check.bind(null,target,!0,image))):(log("Drawing: "+image.src),drawImage(image)));imageLoaded||loading?imageLoaded&&processTargets(imageLoaded):processTargets(target)}}function throttle(callback){!0===get("windowEvents")&&(throttleDelay&&clearTimeout(throttleDelay),throttleDelay=setTimeout(callback,200))}function set(property,newValue){if(void 0===attrs[property])throw"Unknown property - "+property;if(void 0===newValue)throw"Missing value for "+property;if("targets"===property||"images"===property)try{newValue=getElements("images"!==property||newValue?newValue:"img","images"===property)}catch(err){throw newValue=[],err}else checkType(newValue,typeof attrs[property]);removeClasses(),attrs[property]=newValue,check(),"debugOverlay"===property&&showDebugOverlay()}function get(property){if(void 0===attrs[property])throw"Unknown property - "+property;return attrs[property]}function getImageData(){for(var images=get("images"),area,data=[],i=0;i<images.length;i++)area=getArea(images[i]),data.push(area);return data}return{init:init,destroy:destroy,refresh:check,set:set,get:get,getImageData:getImageData}}));